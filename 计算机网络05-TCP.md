---
title: 计算机网络05-TCP
date: 2020-07-16 10:07:21
categories:
	- 计算机网络
tags:
	- 计算机网络
	- 基础知识
mathjax: true
---

### 1. TCP

TCP连接提供的是全双工、点对点的服务。

TCP建立连接是**三次握手**的过程，建立连接之后，客户进程通过套接字传递数据流，然后由TCP控制。TCP将数据引导到该连接的发送缓存(三次握手期间设置的缓存之一)中，然后TCP从缓存中取出一块数据，将其传递到网络层。TCP可以从缓存中取出并放入报文段中的数据数量受限于**最大报文长度(MSS)**，其通常有本地发送主机发送的最大链路层帧长度(**最大传输单元MTU**)来设置。一般来说一个TCP报文段加上TCP/IP首部长度(通常40)要适合单个链路层帧，以太网和PPP链路层协议都有1500字节的MTU，所以MSS的典型值为1460。下面是一个经典的模型。

<img src="计算机网络05-TCP/01.png" alt="image-20200717231532669" style="zoom:50%;" />

### 2. TCP报文结构

下图是TCP报文段结构

<img src="计算机网络05-TCP/02.png" alt="image-20200717231832043" style="zoom: 33%;" />

1. 源端口号与目标端口号，用于多路复用/分解来自上层应用的数据。
2. 32比特序号子段和32比特确认号字段，用于发送方和接收方实现可靠数据传输服务。
3. 16比特的接受窗口字段，用于进行流量控制，表示接收方愿意接收的字节数量。
4. 4比特首部长度字段，指示了以32比特的字为单位的TCP首部长度，TCP长度可变，典型长度为20字节(选项字段为空)
5. 可选与变长的选项字段。
6. 6比特的标志字段。
   - `ACK`指示确认字段的值是有效的
   - `SYN`用于建立链接
   - `FIN`用于拆除链接
   - 其余不常用
7. 检验和字段。

TCP中的序列号和确认号是实现可靠传输服务的关键。

序号表示当前报文携带的应用层数据的第一个字节的编号。可以通过对数据进行划分，然后给每段的第一个字节编号。

确认号表示这个报文发送方希望收到的来自对方的下一字节的序号。假设`A`收到了来自`B`的编号为`0~112`的所有字节的数据，那么`A`给`B`发送的下一个报文中的确认号就是`113`。TCP只确认数据流中至第一个丢失字节为止的字节，即其是**累计确认的**。一般来说，对于接收方如果收到了失序的报文，会保留失序的字节，并等待缺少的字节来填充间隔。在报文中如果没有数据的话，任然需要有序号。一条TCP链接的双方均是随记地选择初始序号(在三次握手阶段相互交换自己选择的初始序号)。下面是一个交换的例子。

<img src="计算机网络05-TCP/03.png" alt="image-20200717234515942" style="zoom: 33%;" />

### 3. 往返时延的估计与超时

如果希望实现超时重传机制，就需要设置超时间隔长度。显然超时时间间隔必须大于该连接的往返时间(RTT)。但是这个时间并不是固定的，需要发送方根据当前网络状况进行估计。

报文段的样本RTT是从某报文被发出到该报文段的确认被收到之间的时间量。由于路由器的拥塞和端系统复杂的变化，SampleRTT的值会随之波动。为了估计一个典型的RTT，要采取某种对SampleRTT取平均的办法。TCP维持一个SampleRTT的均值(EstimatedRTT)，获得一个新的SampleRTT，利用如下的公式来更新EstimatedRTT。$\alpha$推荐值为0.125。

$$EstimatedRTT = (1 - \alpha) EstimatedRTT + \alpha SampleRTT$$

上述是进行**指数加权滑动平均**，最终EstimatedRTT趋于平缓。

除了估算RTT之外，RTT的变化可以用RTT偏差`DevRTT`来估算SampleRTT一般会偏离EstimatedRTT的程度。$\beta$推荐值为0.25。

$$DevRTT = (1 - \beta)  DevRTT + \beta |SampleRTT - EstimatedRTT|$$

有了EstimatedRTT和DevRTT，TCP的超时间隔可以进行如下设置：

1. 超时间隔应该大于等于EstimatedRTT
2. 超时间隔不能大太多，否则当报文丢失时，不能很快重传该报文
3. 当SampleRTT波动大时，余量应该较大，波动较小时余量应该较小。

所以使用下面的公式：

$$TimeoutInterval = EstimatedRTT + 4 \cdot DevRTT$$

初始的TimeoutInterval为1秒，出现超时后加倍，以免即将被确认的后继报文段过早出现超时。然而只要收到报文段就更新EstimatedRTT, 并用上述公式再次计算TimeoutInterval。

